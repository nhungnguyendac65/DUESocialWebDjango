{% extends "core/base.html" %}
{% load static %}

{% block title %}{{ post.title }} - DUE Network{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card mb-3 post-card" id="post-{{ post.id }}">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <a href="{% url 'profile' post.author.username %}">
                            <img src="{{ post.author.profile.avatar.url }}" alt="{{ post.author.username }}" class="rounded-circle me-3" width="50" height="50">
                        </a>
                        <div>
                            <a href="{% url 'profile' post.author.username %}" class="text-decoration-none text-dark">
                                <strong class="d-block fs-5">{{ post.author.get_full_name|default:post.author.username }}</strong>
                            </a>
                            <small class="text-muted">@{{ post.author.username }} &bull; {{ post.created_at|timesince }} ago</small>
                        </div>
                        {% if post.author == request.user or request.user.role in "mod admin" %}
                        <div class="ms-auto dropdown">
                            <button class="btn btn-link text-muted" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-ellipsis-h"></i>
                            </button>
                            <ul class="dropdown-menu">
                                {% if post.author == request.user %}
                                    <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#editPostModal-{{ post.id }}">Sửa bài viết</a></li>
                                    <li>
                                        <form action="{% url 'delete_post' post.id %}" method="POST" onsubmit="return confirm('Bạn có chắc chắn muốn xóa bài viết này?');">
                                            {% csrf_token %}
                                            <button type="submit" class="dropdown-item text-danger">Xoá bài viết</button>
                                        </form>
                                    </li>
                                {% elif request.user.role in "mod admin" %}
                                    <li>
                                        <form action="{% url 'delete_post' post.id %}" method="POST" onsubmit="return confirm('Bạn (Mod/Admin) có chắc chắn muốn xóa bài viết này?');">
                                            {% csrf_token %}
                                            <button type="submit" class="dropdown-item text-danger">Xoá bài viết (Mod/Admin)</button>
                                        </form>
                                    </li>
                                {% else %}
                                    <li><a class="dropdown-item" href="{% url 'report_post' post.id %}">Báo cáo bài viết</a></li>
                                {% endif %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>

                    <h4>{{ post.title }}</h4>

                    {% if post.image %}
                    <img src="{{ post.image.url }}" class="img-fluid rounded my-3" alt="Post image for {{ post.title }}">
                    {% endif %}

                    <div class="post-content-full">
                        {{ post.content|linebreaksbr }}
                    </div>

                    {% if post.file_attachment %}
                    <div class="mt-3">
                        <a href="{{ post.file_attachment.url }}" target="_blank" class="btn btn-outline-secondary">
                            <i class="fas fa-paperclip"></i> {{ post.file_attachment.name|cut:"post_files/" }}
                        </a>
                    </div>
                    {% endif %}
                </div>
                <div class="card-footer bg-transparent d-flex justify-content-around py-2">
                    <button class="btn btn-lg btn-link text-muted like-btn {% if post.is_liked_by_user %}text-danger{% endif %}" data-post-id="{{ post.id }}">
                        <i class="fa-heart {% if post.is_liked_by_user %}fas{% else %}far{% endif %}"></i> <span class="like-count small">{{ post.likes.count }}</span>
                    </button>
                    <button class="btn btn-lg btn-link text-muted" onclick="document.getElementById('comment-input-{{post.id}}').focus()">
                        <i class="far fa-comment"></i> <span class="small">{{ post.comments.count }}</span>
                    </button>
                    <button class="btn btn-lg btn-link text-muted share-btn" data-post-id="{{ post.id }}">
                        <i class="fas fa-share"></i>
                    </button>
                    <button class="btn btn-lg btn-link text-muted bookmark-btn {% if post.is_bookmarked_by_user %}text-primary{% endif %}" data-post-id="{{ post.id }}">
                        <i class="fa-bookmark {% if post.is_bookmarked_by_user %}fas{% else %}far{% endif %}"></i>
                    </button>
                </div>
            </div>

            {% if user.is_authenticated %}
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title">Để lại bình luận</h5>
                    <form method="POST" action="{% url 'api_add_comment' post.id %}" id="comment-form-{{post.id}}" class="comment-form-ajax" data-post-id="{{post.id}}">
                        {% csrf_token %}
                        <div class="d-flex">
                            <img src="{{ request.user.profile.avatar.url }}" alt="{{ request.user.username }}" class="rounded-circle me-2" width="40" height="40" style="margin-top: 5px;">
                            <textarea name="content" class="form-control" id="comment-input-{{post.id}}" rows="2" placeholder="Viết bình luận của bạn..." required></textarea>
                        </div>
                        <div class="text-end mt-2">
                            <button type="submit" class="btn btn-primary btn-sm">Gửi bình luận</button>
                        </div>
                    </form>
                </div>
            </div>
            {% endif %}

            <div class="card">
                <div class="card-body">
                    <h5 class="card-title mb-3">Bình luận (<span id="comment-count-{{post.id}}">{{ post.comments.count }}</span>)</h5>
                    <div id="comments-list-{{post.id}}">
                        {% for comment in comments %}
                            {% include "core/partials/_comment.html" with comment=comment %}
                        {% empty %}
                            <p class="text-muted text-center" id="no-comments-{{post.id}}">Chưa có bình luận nào. Hãy là người đầu tiên!</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if post.author == request.user %}
    {% include "core/partials/_edit_post_modal.html" with post=post post_form=edit_post_form %} {# edit_post_form cần được truyền từ view #}
{% endif %}

{% endblock %}

{% block extra_scripts %}
    <script src="{% static 'core/js/post_interactions.js' %}"></script> {# Giả sử hàm getCookie ở đây #}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.comment-form-ajax').forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const postId = this.dataset.postId;
                const contentTextarea = this.querySelector('textarea[name="content"]');
                const content = contentTextarea ? contentTextarea.value.trim() : null; // Lấy và trim content
                const csrftoken = getCookie('csrftoken'); // Hàm này phải được định nghĩa ở đâu đó (ví dụ: post_interactions.js)

                if (!content) { // Kiểm tra content rỗng ở client-side
                    alert("Vui lòng nhập nội dung bình luận.");
                    return;
                }

                fetch(this.action, { // this.action là {% url 'api_add_comment' post.id %}
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ content: content })
                })
                .then(response => {
                    if (!response.ok) { // Nếu server trả về lỗi (4xx, 5xx)
                        return response.json().then(errData => {
                            // Xử lý lỗi chi tiết hơn
                            let errorMessage = "Lỗi không xác định khi gửi bình luận.";
                            if (errData.content && Array.isArray(errData.content)) {
                                errorMessage = errData.content.join(" ");
                            } else if (typeof errData === 'string') {
                                errorMessage = errData;
                            } else if (errData.detail) {
                                errorMessage = errData.detail;
                            } else {
                                errorMessage = JSON.stringify(errData);
                            }
                            throw new Error(errorMessage);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    // 'data' bây giờ là object comment đã được serialize, ví dụ:
                    // data = { id: 1, post: 1, author: {id:1, username:'admin', avatar_url:'...'}, content:'...', created_at:'...' }
                    if (data.id && data.author) {
                        const commentsList = document.getElementById('comments-list-' + postId);
                        const noCommentsMsg = document.getElementById('no-comments-' + postId);
                        if (noCommentsMsg) noCommentsMsg.style.display = 'none';

                        const newCommentDiv = document.createElement('div');
                        newCommentDiv.classList.add('comment-item', 'd-flex', 'mb-3');
                        newCommentDiv.id = `comment-${data.id}`;

                        // Lấy thông tin author từ data.author
                        const authorUsername = data.author.username || "Ẩn danh";
                        const authorFullName = (data.author.first_name ? `${data.author.first_name} ${data.author.last_name || ''}`.trim() : authorUsername);
                        const authorAvatarUrl = data.author.avatar_url; // Đã có URL đầy đủ từ serializer

                        newCommentDiv.innerHTML = `
                            <a href="/profile/${authorUsername}/" class="flex-shrink-0">
                                <img src="${authorAvatarUrl}" alt="${authorUsername}" class="rounded-circle me-2" width="35" height="35" style="object-fit: cover;">
                            </a>
                            <div class="flex-grow-1">
                                <div class="bg-light p-2 rounded">
                                    <a href="/profile/${authorUsername}/" class="text-decoration-none fw-bold text-dark">${authorFullName}</a>
                                    <p class="mb-0 small">${data.content.replace(/\n/g, '<br>')}</p>
                                </div>
                                <small class="text-muted ms-2">${new Date(data.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}, ${new Date(data.created_at).toLocaleDateString()}</small>
                            </div>`;

                        if(commentsList) {
                            commentsList.appendChild(newCommentDiv); // Thêm vào cuối
                        }
                        if(contentTextarea) contentTextarea.value = ''; // Xóa nội dung textarea

                        // Cập nhật số lượng comment
                        const commentCountSpan = document.getElementById('comment-count-' + postId);
                        if(commentCountSpan) commentCountSpan.textContent = parseInt(commentCountSpan.textContent) + 1;

                        const postCardCommentCount = document.querySelector(`#post-${postId} .card-footer .fa-comment + .small`);
                        if(postCardCommentCount) postCardCommentCount.textContent = parseInt(postCardCommentCount.textContent) + 1;

                    } else {
                        console.error('Lỗi khi thêm bình luận (dữ liệu trả về không có id hoặc author):', data);
                        alert('Đã có lỗi xảy ra khi xử lý bình luận của bạn.');
                    }
                })
                .catch(error => {
                    console.error('Lỗi kết nối hoặc lỗi từ server khi gửi bình luận:', error);
                    alert('Lỗi: ' + error.message);
                });
            });
        });
    });
    </script>
{% endblock %}